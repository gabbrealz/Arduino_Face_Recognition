<!DOCTYPE html>
<html>
<head>
    <title>ESP32-CAM Stream</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial;
            text-align: center;
            background: #111;
            color: white;
        }
        img {
            margin-top: 20px;
            border: 3px solid white;
            width: 480px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<h2>ESP32-CAM Live Stream</h2>

<button onclick="startStream()">Start Stream</button>
<button onclick="stopStream()">Stop Stream</button>
<button onclick="singleCapture()">Capture Once</button>

<br>
<img id="streamImage" />

<script>
    const brokerUrl = "ws://localhost:9001";
    const client = mqtt.connect(brokerUrl);

    let receiving = false;
    let imageChunks = [];

    client.on("connect", () => {
        console.log("Connected to MQTT");
        client.subscribe("camera/stream");
    });

    client.on("message", (topic, message) => {

        // Only treat VERY SMALL payloads as control signals
        if (message.length <= 5) {
            const text = message.toString();

            if (text === "START") {
                receiving = true;
                imageChunks = [];
                return;
            }

            if (text === "END") {
                receiving = false;

                const blob = new Blob(imageChunks, { type: "image/jpeg" });
                const imageUrl = URL.createObjectURL(blob);

                document.getElementById("streamImage").src = imageUrl;
                return;
            }
        }

        if (receiving) {
            imageChunks.push(message);
        }
    });

    function startStream() {
        client.publish("esp32/capture", "STREAM ON");
    }

    function stopStream() {
        client.publish("esp32/capture", "STREAM OFF");
    }

    function singleCapture() {
        client.publish("esp32/capture", "CAPTURE");
    }
</script>

</body>
</html>